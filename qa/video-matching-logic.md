# Video Matching Logic

## Background

Local Soundcheck shows YouTube video previews for upcoming artists at small venues. Getting the right video is critical — a wrong video (e.g., a Hank Williams song instead of the NC bluegrass band "Six More Miles") erodes user trust. No video (a "no preview" popup) is always preferable to the wrong video.

This document captures the design decisions and logic for how we find, verify, and assign YouTube videos to artists.

## Problem with the Original System

The original scraper (`base_scraper.py`) did three jobs at once: scraping venue websites, searching YouTube, and deciding whether to trust the result. Issues:

1. **No verification gate** — the scraper's confidence score (70+ = accept) was the only check. A video went live the moment the scraper assigned it. Users saw wrong matches before anyone could catch them.

2. **No concept of "intentionally no video"** — when we manually nulled out a wrong video, the smart filter saw `youtube_id: null` and treated the artist as brand new, re-searching and re-assigning the same wrong video the next night.

3. **Pure string matching** — the only signals were whether the artist name appeared in the video title or channel name. No view count, upload date, or channel analysis. "Six More Miles" matched a Hank Williams song because the title contained all three words.

4. **Aggressive coverage bias** — the system tried hard to find something for every band. This is backwards for our product. Coverage should grow organically as matches are verified, not forced.

## Architecture: Four Separate Concerns

### 1. Scraper (base_scraper.py + venue scrapers)
- Scrapes venue websites for show data (dates, artists, openers, ticket URLs)
- Applies show-level overrides (festival names to real band names)
- Cleans artist names (strip tour suffixes, colons, "Presents", "feat.", split multi-artist on comma/" / "/"w/")
- Searches YouTube API to find candidate videos for new/unverified artists
- Does NOT make the final assignment. Tags new matches as "unverified" with the candidate stored separately
- Preserves existing verified and overridden video assignments — never overwrites them

### 2. Spotify Enrichment (scripts/spotify_enrich.py)
- Searches Spotify for each artist, confirms they exist as a real music act
- Caches artist metadata in `qa/spotify_cache.json`: popularity (0-100), genres, followers
- Three match tiers: exact (1.0), close (0.8+), partial (0.5+)
- Used by verifier for identity confirmation and view cap tiering
- 30-day cache TTL, ~1 API call per artist (search only)

### 3. Verifier (scripts/verify_videos.py)
- Only looks at unverified candidates
- Runs multi-step checks against each candidate (see Verification Pipeline below)
- Promotes passing candidates to "verified" (video goes live)
- Rejects failing candidates (no-preview popup assigned)
- Logs everything for the daily report

### 4. Daily Video Report (generated by verifier)
- Summarizes tonight's changes
- Lists newly verified videos (spot-check opportunities)
- Lists rejected candidates with reasons (calibration opportunities)
- Shows full no-preview queue (manual review work queue)
- Posted as GitHub Issue (triggers email notification)
- CSV saved to `qa/video-report-YYYY-MM-DD.csv`

This separation means we can iterate on verification logic without risking scraper stability, and we can run the verifier independently for manual reviews.

## Video States

Each artist's video assignment is in one of three states:

| State | Meaning | Can be overwritten? |
|-------|---------|-------------------|
| **Override** | You or I manually picked this video (or manually set null). Stored in `overrides.json`. | Only by another manual override |
| **Verified** | Passed the automated verification pipeline. | No — locked in until show expires or manual override |
| **Unverified** | Scraper found a candidate but verifier hasn't checked it yet. Shows no-preview popup until verified. | Yes — by the verifier promoting or rejecting it |

Key principle: **users never see an unverified match.** The no-preview popup is the default until a video is verified or overridden.

## Decision Tree (Full Logic Path)

### Phase 1: Scraper — Schedule Updates
1. Scrape venue website for current show listings
2. Apply show-level overrides (e.g., "Carrboro Bluegrass Festival Presents..." becomes artist: "Six More Miles", opener: "North State Grass")
3. Update schedule data: new shows, date changes, cancellations, new openers
4. For each artist, check video state:
   - **Override exists?** Use it (including null). Done.
   - **Already verified?** Keep it. Done.
   - **New artist or previously rejected?** Proceed to candidate search.

### Phase 2: Scraper — YouTube Candidate Search
5. Clean artist name (strip tour info, colons, "Presents", "feat.", split multi-artist on comma/" / "/"w/")
6. Check event keywords on original name (Cabaret, Showcase, DJ Night, etc.) — if match, skip (not a band)
7. Check manual overrides for cleaned name
8. Search YouTube API: `"{artist} official music video"` with Music category filter (100 quota units)
9. If no results, retry: `"{artist} band music"` without category filter (100 quota units)
10. Score each candidate (up to 5) using string matching:
    - Channel name contains artist name: 95
    - Artist name contains channel name: 85
    - 50%+ channel word overlap: 70-90
    - Multi-word artist in title: 75
    - Single-word artist at title start: 55
    - Partial matches: 20-45
    - No match: 5
11. Pick highest-scoring candidate. Store as unverified with candidate ID, score, and explanation. **Do not assign to youtube_id yet.** User sees no-preview popup.

### Phase 3: Spotify Enrichment
12. For each artist across all venues, search Spotify API for a matching artist
13. Score name similarity (exact, close 0.8+, partial 0.5+) with length ratio guard
14. Cache result in `qa/spotify_cache.json`: spotify_id, popularity, genres, followers, match confidence
15. Results used by verifier for identity confirmation and view cap tiering

### Phase 4: Verifier — Multi-Step Validation
16. **Generic venue image check** (free, no API call) — if the show's image URL matches a known venue placeholder (e.g., Cat's Cradle uses `cradlevenue.png`), flag as likely event rather than band.
17. For each unverified candidate, pull video metadata from YouTube `videos` endpoint (1 quota unit):
    - **View count check** — tiered caps based on Spotify popularity and channel trust (see View Count Caps table below)
    - **Topic channel exception** — if the video is from a YouTube auto-generated "{ArtistName} - Topic" channel and the artist name matches, skip the view count check entirely
    - **Upload date check** — reject if video is 15+ years old AND channel doesn't match artist (unless trusted channel)
18. Pull channel info from YouTube `channels` endpoint (1 quota unit):
    - **Trusted channel detection** — check if channel is a known label (14 on allowlist) or VEVO channel. Trusted channels bypass channel mismatch, upload age, and Spotify no_match rejections.
    - **Channel name match** — does the channel name relate to the artist?
    - **Subscriber count as modifier** — non-matching channel + 2M+ subscribers = reject (unless trusted). Matching channel + low subscribers = fine.
19. **Spotify identity check** — if Spotify cache says `no_match` AND channel doesn't match AND not a trusted channel → reject. Close/partial Spotify match + channel mismatch → warn.
20. Apply combined signals:
    - **Pass all checks** → promote to "verified," assign youtube_id, video goes live
    - **Fail any check** → reject, assign no-preview, log the reason
    - Design choice: "fail any = reject" is deliberately conservative

### Phase 5: Daily Report
21. Generate markdown report + CSV covering:
    - **Summary** — counts (verified, rejected, no-preview, changes)
    - **Verified Videos** — what passed and went live (with Spotify status)
    - **Rejected Candidates** — what failed, with specific reasons and Spotify annotation
    - **No Preview Queue** — all artists currently showing the popup
22. Post as GitHub Issue (label: `daily-video-report`)
23. Save CSV to `qa/video-report-YYYY-MM-DD.csv`

## View Count Caps

All venues are small indie rooms (100-750 capacity). The cap system balances catching wrong matches (famous song collisions) against accepting legitimate videos for known artists.

| Condition | Cap | Rationale |
|-----------|-----|-----------|
| Default (no Spotify data or popularity < 30) | 5M | Bands at small venues typically have 10K-2M view videos |
| Spotify popularity >= 30 | 10M | Established indie artist with real streaming numbers |
| Spotify popularity >= 50 | 50M | Mid-tier artist, high views are plausible |
| Spotify popularity >= 70 | No cap | Major artist — any view count is expected |
| Trusted label channel (14 labels) | 50M | Known label, video is legitimate |
| VEVO channel | 50M | Same trust as labels |
| Topic channel (artist name match) | No cap | YouTube itself confirmed the artist identity |

### Trusted Labels (14)
Nuclear Blast, Epitaph, Fueled By Ramen, Spinnin', Secret City, Innovative Leisure, SideOneDummy, Rise, Fearless, Century Media, New West, Flightless, Warner, Carpark

EMPIRE was evaluated and removed — "empire" is too generic as a normalized key, creating false positive risk.

### Trusted Channel Bypasses
Trusted labels and VEVO channels bypass:
- Channel mismatch rejection (2M+ subscriber threshold)
- Upload age rejection (15+ year threshold)
- Spotify `no_match` rejection

## Quota Budget

YouTube Data API free tier: 10,000 units/day. Resets at midnight Pacific.

| Operation | Cost | Volume | Total |
|-----------|------|--------|-------|
| Search (scraper, new artists) | 100 units | ~97 searches | ~9,700 |
| Video metadata (verifier) | 1 unit | ~60-70 videos | ~70 |
| Channel info (verifier) | 1 unit | ~60-70 channels | ~70 |
| **Total** | | | **~9,840** |

**Current issue (Feb 2026):** Scraper searches consume nearly the entire daily quota, leaving the verifier starved. With 13 venues, ~97 new/re-searches run nightly. Smart search reuse helps established venues (75-90% reuse) but new venues start with low reuse (40-55%). Fix in progress: separate API key for verifier and smarter search filtering to reduce scraper quota usage.

**Target budget after fix:**
| Operation | Cost | Volume | Total |
|-----------|------|--------|-------|
| Search (scraper, optimized) | 100 units | ~50-60 searches | ~5,000-6,000 |
| Video metadata (verifier, separate key) | 1 unit | ~70 videos | ~70 |
| Channel info (verifier, separate key) | 1 unit | ~70 channels | ~70 |

## Root Cause: Why Six More Miles Kept Getting Overwritten

The `_load_existing_matches()` function in `base_scraper.py` only loads artists into the "existing matches" dictionary if `youtube_id` is truthy:

```python
if artist and yt_id:
    matches[artist] = yt_id
```

When we manually set `youtube_id: null`, the artist was excluded from existing matches. The smart filter then treated it as a "new artist" and re-searched YouTube, finding the same wrong Hank Williams video every night.

The fix: the new system treats "verified" and "override" as durable states stored separately from the youtube_id field itself. A null override means "I chose no video" — not "please search again."

## Planned Enhancement: Multi-Act Openers

Currently each show has a single `opener` string and one `opener_youtube_id`. The scraper splits on comma, takes the first name, and that single video represents all openers.

The plan is to change the data model so each opener is a separate entry with its own name and video:

```json
"openers": [
    {"name": "Full Body 2", "youtube_id": "xe7rEv5UgRA"},
    {"name": "Cryogeyser", "youtube_id": null},
    {"name": "VMO a.k.a. Violent Magic Orchestra", "youtube_id": null}
]
```

Each opener gets their own play button on the site and goes through the same verification pipeline. This is a significant change touching the data format, every scraper, the verifier, and app.js. It will be implemented after the current pipeline stabilizes.

## Design Principles

1. **No video is better than wrong video** — the no-preview popup is an acceptable user experience. A wrong video is not.
2. **Confirmed videos are immutable** — once verified or overridden, the nightly scrape cannot change them.
3. **The daily report is a feedback loop** — rejected candidates teach us where the rules are too tight. Wrong matches that slip through teach us where they're too loose.
4. **Separation of concerns** — scraper finds candidates, Spotify confirms identity, verifier validates, report surfaces results. Each can be improved independently.
5. **Conservative by default** — when in doubt, show no preview. Coverage grows as we verify, not as we guess.
